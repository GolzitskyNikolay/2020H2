# Лабораторная №1 (неблокирующие сокеты)

В данной ветке репозитория находится код чата, работающего поверх транспортного протокола TCP.

## Инструкция по использованию

Программы сервера и клиента написаны на Python 3. Для выполнения должен присутствовать интерпритатор python3.7 (не тестировалось на более низких версиях).

### Сервер

Сервер запускается так:

```
./server.py [опции]
```

Опции:
  - **--host HOST** IP адрес, на котором следует прослушивать TCP подключения (по умолчанию `0.0.0.0`);
  - **--port PORT** номер TCP порта серверного сокета (по умолчанию `9000`);
  - **--max-username-size MAX_USERNAME_SIZE** максимальный размер имени пользователя (по умолчанию `25`);
  - **--max-message-size MAX_MESSAGE_SIZE** максимальный размер сообщения от клиента (по умолчанию `3000`).

Все опции тут не обязательны.

Если были нарушены условия максимального размера имени пользователя или максимального размера сообщения пользователя, то сервер разрывает соединение.

### Клиент

Для клиента обязательно следует указать имя пользователя, которое будет использовано в чате.

```
./client.py [опции] username
```

Опции:
  - **--host HOST** имя хоста для подключения (по умолчанию `localhost`);
  - **--port PORT** TCP порт чата на этом хосте хоста (по умолчанию `9000`).

Клиент пытается прочесть строку из стандартного потока ввода и отправляет её на сервер чата.

Сообщения, которые приходят от сервера выводятся в оговоренном к этой лабораторной формате.

## Описание используемого сетевого протокола

Каждое сообщение, передающееся по TCP зависит от контекста, соответствено формат сообщения определяется по тому, кто является сервером, кто клиентом и на какой стадии находится подключение.

### Используемые типы данных

Независимо от этапа подключения, каждое сообщение может содержать несколько полей следующих типов данных:
  - временная метка (timestamp),
  - текстовая строка (string).

Временная метка (timestamp) представляет из себя целое беззнаковое число длинной в 8 байт. В этом числе хранится количество секунд в [формате UNIX](https://en.wikipedia.org/wiki/Unix_time).

Текстовая строка (string) состоит из байтов (bytes), которые кодируют текст в формате [UTF-8](https://ru.wikipedia.org/wiki/UTF-8) и целого беззнакового числа (size), которое равно количеству этих байт. Размер size при этом 4 байта. Для передачи текстовой строки по TCP необходимо сначала ппередать size, а затем сразу же bytes.

### Протокол

Здесь описывается клиент-серверное взаимодействие со стороны клиента. Сервер может на любом этапе разорвать соединение без соответствующего сообщения о причине (напаример если ограничени на размер сообщения было нарушено).

#### Инициализация

Каждый клиент устанавливает TCP соединение с сервером чата. После подключения клиент должен сообщить серверу, кто он. Для этого он передаёт данные типа string серверу, в которых находится имя пользователя. После этого клиент может перейти к этапу "работа". Сервер при этом запоминает имя клиента и использует его для того чтобы сообщать остальным пользователем чата, кто отправил сообщение.

#### Работа

После перехода в на этот этап клиент может получать сообщения от других пользователей чата и отправлять свои сообщения. Формат отправляемых и принимаемых сообщений различается.

Чтобы отправить текстовое сообщение в чат, клиент должен обладать всем сообщением целиком (нельзя отправлять сообщение не зная его размер). Если это условие соблюдено, то клиенту просто следует отправить сообщение в формате string.

Принимаемые сообщение состоят из трёх частей, которые последовательно передаются от сервера к клиенту:
  - timestamp -- время примёма сообщения сервером;
  - string -- имя пользователя, который отправил сообщение;
  - string -- сообщение пользователя.

Для выхода из чата клиенту следует просто разорвать существующее TCP соединение.

#### Ограничение на размер сообщения и имени пользователя

Сервер может дополнительно ограничить сверху множество допустимых значений поля size в типе данных string в сообщениях, которые приходят от клиента. Допустимые значения должны быть изначально известны клиенту, то-есть следует договориться об этих ограничениях. Вводятся два типа таких ограничений: ограничение на размер имени пользователя и ограничение на размер сообщения.

Оба ограничения созданы в целях оптимизации работы сервера. Каждое сообщение должно быть полностью считано сервером прежде чем оно будет переслано клиентам. Часто нет возможности хранить сообщение размером 2^32-1 байтов (максимальное значение size) на сервере, поэтому вводится ограничение на размер сообщения. Та же самая причина распространяется на длину имени пользователя, но кроме того слишком длинное имя пользователя смотрится не хорошо в чате и трудно запоминается, поэтому ограничение на размер имени пользователя следует сделать строже.
